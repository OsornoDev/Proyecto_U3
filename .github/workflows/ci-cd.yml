name: CI-CD Transaction Validator

on:
  push:
    branches: ["main"]

jobs:
  build-test-package-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install deps
        run: npm install

      - name: Run tests
        run: npm test

      - name: Build stable image (previous commit)
        run: |
          git checkout ${{ github.event.before }}
          docker build -t transaction-validator:${{ github.event.before }} .
          git checkout ${{ github.sha }}

      - name: Build canary image (current commit)
        run: |
          docker build -t transaction-validator:${{ github.sha }} .

      - name: Deploy gateway with 20% canary
        env:
          STABLE_TAG: ${{ github.event.before }}
          CANARY_TAG: ${{ github.sha }}
        run: |
          sed -i 's/validator-stable:8080 weight=[0-9]\+/validator-stable:8080 weight=80/' deploy/nginx.conf
          sed -i 's/validator-canary:8080 weight=[0-9]\+/validator-canary:8080 weight=20/' deploy/nginx.conf
          docker compose -f deploy/docker-compose.prod.yml up -d
          for i in {1..20}; do
            if curl -fsS http://localhost:8080/health | grep -q '"ok"'; then break; fi; sleep 3; done

      - name: Gating check 20%
        run: |
          curl -fsS -X POST http://localhost:8080/validate \
            -H 'Content-Type: application/json' \
            -d '{"amount":100,"currency":"MXN","accountId":"acc-1"}' || exit 1

      - name: Shift to 40% canary
        run: |
          sed -i 's/validator-stable:8080 weight=[0-9]\+/validator-stable:8080 weight=60/' deploy/nginx.conf
          sed -i 's/validator-canary:8080 weight=[0-9]\+/validator-canary:8080 weight=40/' deploy/nginx.conf
          docker exec gateway nginx -s reload
          curl -fsS -X POST http://localhost:8080/validate \
            -H 'Content-Type: application/json' \
            -d '{"amount":100,"currency":"MXN","accountId":"acc-1"}' || exit 1

      - name: Shift to 60% canary
        run: |
          sed -i 's/validator-stable:8080 weight=[0-9]\+/validator-stable:8080 weight=40/' deploy/nginx.conf
          sed -i 's/validator-canary:8080 weight=[0-9]\+/validator-canary:8080 weight=60/' deploy/nginx.conf
          docker exec gateway nginx -s reload
          curl -fsS -X POST http://localhost:8080/validate \
            -H 'Content-Type: application/json' \
            -d '{"amount":100,"currency":"MXN","accountId":"acc-1"}' || exit 1

      - name: Shift to 100% canary
        run: |
          sed -i 's/validator-stable:8080 weight=[0-9]\+/validator-stable:8080 weight=0/' deploy/nginx.conf
          sed -i 's/validator-canary:8080 weight=[0-9]\+/validator-canary:8080 weight=100/' deploy/nginx.conf
          docker exec gateway nginx -s reload
          curl -fsS -X POST http://localhost:8080/validate \
            -H 'Content-Type: application/json' \
            -d '{"amount":100,"currency":"MXN","accountId":"acc-1"}' || exit 1

      - name: Post-deploy validation
        run: |
          for i in {1..10}; do curl -fsS http://localhost:8080/health | grep -q '"ok"' || exit 1; sleep 1; done
          for i in {1..10}; do \
            curl -fsS -X POST http://localhost:8080/validate \
              -H 'Content-Type: application/json' \
              -d '{"amount":100,"currency":"MXN","accountId":"acc-1"}' || exit 1; \
            sleep 1; done

      - name: Rollback to stable if failure
        if: failure()
        run: |
          sed -i 's/validator-stable:8080 weight=[0-9]\+/validator-stable:8080 weight=100/' deploy/nginx.conf
          sed -i 's/validator-canary:8080 weight=[0-9]\+/validator-canary:8080 weight=0/' deploy/nginx.conf
          docker exec gateway nginx -s reload
          curl -fsS http://localhost:8080/health | grep -q '"ok"' || exit 1

      - name: Teardown simulated production
        if: always()
        run: |
          docker compose -f deploy/docker-compose.prod.yml down
